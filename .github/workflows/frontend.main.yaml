name: deploy_frontend
# Deploys when push is made from frontend folder

on:
    push:
        branches: [ main ]
        paths:
        - 'Frontend/**' 
        - '!**.md'  

permissions:
      id-token: write
      contents: read

jobs: 
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Upload to blob storage
      uses: azure/CLI@v1
      with:
        azcliversion: latest
        inlineScript: |
          echo "Uploading frontend files to Azure Storage..."
          
          # Upload with overwrite flag
          az storage blob upload-batch \
            --account-name webfilesazureresume985 \
            --auth-mode key \
            --destination '$web' \
            --source Frontend/ \
            --overwrite \
            --only-show-errors
          
          if [ $? -eq 0 ]; then
            echo "Upload successful!"
          else
            echo "Upload failed"
            exit 1
          fi
    - name: Verify upload
      run: |
          echo "Verifying files in Azure Storage..."
          az storage blob list \
            --account-name webfilesazureresume985 \
            --container-name '$web' \
            --output table \
            --auth-mode key \
            --query "[].{Name:name, LastModified:properties.lastModified}"

    - name: Purge Cloudflare Cache 
      env:
        CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      if: env.CLOUDFLARE_ZONE_ID != ''
      run: |
        echo "Purging Cloudflare cache for $CLOUDFLARE_ZONE_ID..."
        curl -X POST "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache" \
          -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}' \
          --fail \
          --silent \
          --show-error
          echo "Cloudflare cache purged successfully!"

    # - name: Purge CDN endpoint
      # uses: azure/CLI@v1
      # with:
        # inlineScript: |
           # az cdn endpoint purge --content-paths  "/*" --profile-name "CDN_PROFILE_NAME" --name "CDN_ENDPOINT" --resource-group "RESOURCE_GROUP"

  # Azure logout
    - name: logout
      run: |
            az logout
      if: always()